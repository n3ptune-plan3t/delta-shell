#!/bin/bash

WIDGETS=("applauncher" "clipboard" "quicksettings" "powermenu" "calendar" "notificationslist" "volume" "network" "bluetooth" "power")

DATADIR="@DATADIR@"

if [[ "$DATADIR" == "@"DATADIR"@" ]]; then
    DATADIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
    IS_DEV=true
else
    APP_ENTRY="$DATADIR/delta-shell-app"
    IS_DEV=false
fi

run_and_check() {
    local output
    output=$( "$@" 2>&1 )
    local exit_code=$?
    if [[ "$output" == *"Unknown request"* ]]; then
        echo "$output"
        exit 1
    else
        [[ -n "$output" ]] && echo "$output"
        return $exit_code
    fi
}

setup_wayland_fractional_scaling() {
    # Keep GTK on native Wayland so it can use wp_fractional_scale_v1 when available.
    if [[ -n "$WAYLAND_DISPLAY" ]]; then
        export GDK_BACKEND="wayland"
    fi

    # Avoid integer-only scaling override; keep room for fractional DPI override.
    unset GDK_SCALE

    # Optional fractional app-scale override (e.g. 1.25, 1.5).
    # When unset, GTK follows compositor/native protocol scaling.
    if [[ -n "$DELTA_SHELL_SCALE" ]]; then
        if [[ "$DELTA_SHELL_SCALE" =~ ^[0-9]+([.][0-9]+)?$ ]]; then
            export GDK_DPI_SCALE="$DELTA_SHELL_SCALE"
        else
            echo "delta-shell: ignoring invalid DELTA_SHELL_SCALE='$DELTA_SHELL_SCALE' (expected float like 1.25)" >&2
        fi
    fi
}

print_help() {
    cat <<EOF
Usage: $(basename "$0") <command> [options]

Available Commands:
   run            Run the shell
   quit           Quit the shell
   restart        Restart the shell
   toggle         Toggle visibility of a widget
   help           Show this help message

Available widgets for toggle:
$(printf "   %s\n" "${WIDGETS[@]}")

Flags:
   -h, --help     help for delta-shell

Running mode: $([ "$IS_DEV" = true ] && echo "Development" || echo "Installed")
EOF
}

main() {
    if [ $# -lt 1 ]; then
        print_help
        exit 0
    fi

    case $1 in
        run)
            setup_wayland_fractional_scaling
            if [ "$IS_DEV" = true ]; then
                exec ags run -d "$DATADIR" --define DATADIR=null
            else
                exec "$DATADIR/delta-shell-app"
            fi
            ;;
        quit)
            ags -i delta-shell quit
            ;;
        restart)
            ags -i delta-shell quit
            setup_wayland_fractional_scaling
            if [ "$IS_DEV" = true ]; then
                exec ags run -d "$DATADIR" --define DATADIR=null
            else
                exec "$DATADIR/delta-shell-app"
            fi
            ;;
        toggle)
            if [ "$#" -lt 2 ]; then
                echo "Available widgets for toggle:"
                printf "  - %s\n" "${WIDGETS[@]}"
                exit 0
            fi
            run_and_check ags -i delta-shell request toggle "$2"
            ;;
        help|-h|--help)
            print_help
            ;;
        *)
            run_and_check ags -i delta-shell request "$@"
            ;;
    esac
}

main "$@"
